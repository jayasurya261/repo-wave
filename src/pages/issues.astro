---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import SidebarFilter from '../components/SidebarFilter.astro';
import SearchBar from '../components/SearchBar.astro';
import IssueCard from '../components/IssueCard.astro';

import { fetchAllRecords } from '../lib/fetchAll';

// We still need repos to extract unique languages for the sidebar filter
const repos = await fetchAllRecords('repos', 'language', 'language', true, 5000);

// Extract unique languages from repos for the filter panel
const uniqueLanguages = repos 
	? [...new Set(repos.map(r => r.language).filter(Boolean))].sort()
	: [];

// Fetch recent issues and join with repos to get language
const issuesRaw = await fetchAllRecords('issues', '*, repos(language)', 'created_at', false, 5000);
const reposError = null;
const issuesError = null;

// Map issues to easily extract language from the joined repo
const issues = issuesRaw?.map((issue: any) => ({
	...issue,
	language: issue.repos?.language || ''
}));

const error = reposError || issuesError;
---

<Layout title="All Issues | Open Source Finder" description="Browse all beginner-friendly open-source issues to kickstart your contributions.">
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

		{error && (
			<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-8">
				<p class="font-semibold">Error fetching data</p>
				<p class="text-sm mt-1">{error.message}</p>
			</div>
		)}

		<!-- Main Layout with Sidebar and Content -->
		<div class="flex flex-col md:flex-row gap-8">
			
			<SidebarFilter uniqueLanguages={uniqueLanguages} />

			<!-- Main Content Area -->
			<main class="flex-grow min-w-0">
				
				<SearchBar />

				<!-- Issues Section -->
				<section class="mb-12">
					<h1 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
						All Issues
						<span id="issueCount" class="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{issues ? issues.length : 0}</span>
					</h1>
					{issues && issues.length > 0 ? (
						<div id="issueList" class="bg-white rounded-xl shadow-sm border border-green-500 divide-y divide-gray-100">
							{issues.map((issue: any) => <IssueCard issue={issue} />)}
						</div>
					) : (
						<p class="text-gray-500">No issues found.</p>
					)}
					<div id="noIssuesMsg" class="hidden text-gray-500 mt-4 p-4 bg-gray-50 rounded-lg border border-gray-100 text-center">No issues match your search.</div>
					<div id="paginationContainer" class="mt-8"></div>
				</section>
                
                <!-- Hidden repo elements so the shared filter.js doesn't crash if it looks for them -->
                <div id="repoCount" class="hidden text-sm font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full"></div>
                <div id="noReposMsg" class="hidden"></div>
                <button id="showMoreReposBtn" class="hidden"></button>

			</main>
		</div>
	</div>
</Layout>

<script is:inline src="/filter.js"></script>
